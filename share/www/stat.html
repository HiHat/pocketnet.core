<!DOCTYPE html>
<html>
<head>
    <title>PocketnetCore Monitoring</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            padding: 15px;
            background-color: #fff;
        }
        table {
            width: 100%;
            max-width: 800px;
            margin: auto;
            border-collapse: collapse;
        }
        header {
            margin-bottom: 2.3em;
        }
        tr:hover td {
            background-color: #a2d6ff;
        }
        th {
            background-color: #007bff;
            color: white;
            text-align: left;
            width: 20%;
        }
        .tHead {
            background-color: #c8dcf1;
        }
        td {
            text-align: right;
            padding: 2px 5px 2px 5px;
            word-break: break-all;
            font-size: 0.7em;
        }
        .tKey {
            text-align: left;
            word-break: normal;
            background-color: #f9f9f9;
        }
        .tValueSql {
        }
        #updateCounter {
            text-align: right;
        }
        .tEgg {
            background-color: white;
        }
        .tOdd {
            background-color: #f6fbff;
        }
    </style>
</head>
<body>
    <header>
        <div style='float: left;'>PocketnetCore Monitoring</div>
        <div id='updateCounter' style='float: right;'></div>
    </header>
    
    <div id='monitoringTablesBox'>
        <table class="monitoringTable"></table>
    </div>
    
    <script>
        var updateCounter = 0;
        
        setInterval(function() {
            document.getElementById('updateCounter').innerText = 'Last update: ' + updateCounter + ' seconds ago';
            updateCounter++;
        }, 1000);

        var box = document.getElementById('monitoringTablesBox');

        var cleanBox = function() {
            document.querySelectorAll('.monitoringTable').forEach(function(t) {
                t.remove();
            });
        }
        
        var update = function() {
            fetch(location.protocol + '//' + location.host.split(':')[0] + ':38081/rpc/getlateststat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'method': 'getlateststat',
                    'params': []
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }
                return response.json();
            })
            .then(json => {
                updateCounter = 0;
                cleanBox();
                
                for (let section in json.result) {
                    if (section == 'RPC')
                        continue;

                    // New table
                    let table = document.createElement("table");
                    table.classList.add('monitoringTable')
                    box.appendChild(table)

                    // Header
                    let row = table.insertRow(-1);
                    let cellHead = row.insertCell(-1);
                    cellHead.innerText = section;
                    cellHead.classList.add('tHead');
                    cellHead.colSpan = 2;

                    if (section == 'SQLBench')
                        cellHead.colSpan = 5;

                    // Rows
                    let i = 0
                    let sectionVals = json.result[section]
                    for (let key in sectionVals) {
                        let row = table.insertRow(-1);

                        // Row header
                        let cellKey = row.insertCell(-1);
                        cellKey.innerText = key;
                        cellKey.classList.add('tKey');
                        cellKey.classList.add(i % 2 == 0 ? 'tOdd' : 'tEgg');

                        // Row
                        if (section == 'SQLBench') {
                            // For SQLBench need more columns
                            let vals = sectionVals[key].split(' / ');
                            for (let val in vals) {
                                let cellValue = row.insertCell(-1);
                                cellValue.innerText = vals[val];
                                cellValue.classList.add('tValue');
                                cellValue.classList.add('tValueSql');
                                cellValue.classList.add(i % 2 == 0 ? 'tOdd' : 'tEgg');
                            }
                        } else {
                            // Simple row
                            let cellValue = row.insertCell(-1);
                            cellValue.innerText = sectionVals[key];
                            cellValue.classList.add('tValue');
                            cellValue.classList.add(i % 2 == 0 ? 'tOdd' : 'tEgg');
                        }

                        i += 1;
                    }
                }
            })
            .catch(function() {
                cleanBox();
                let errSpan = document.createElement("div");
                errSpan.classList.add('error')
                errSpan.innerText = 'Error fetching data from API';
            });
        }
        // setInterval(update, 15000);
        update()
    </script>
</body>
</html>
